@startuml
title las2peer Network: State Machine

[*] --> Disconnected

state "Node States" as Node {
  [*] --> Disconnected
  Disconnected --> Joining : joinNetwork()
  Joining --> Connected : join success
  Joining --> Disconnected : join failed
  Connected --> Ready : routing updated
  Ready --> Processing : service request
  Processing --> Ready : request done
  Ready --> Disconnected : leave network
}

state "Service States" as Service {
  [*] --> Idle
  Idle --> Receiving : message received
  Receiving --> Executing : dispatch to agent
  Executing --> Responding : execution complete
  Responding --> Idle : response sent
}

state "Message States" as Message {
  [*] --> Created
  Created --> Encrypted : encrypt & sign
  Encrypted --> Routing : send via overlay
  Routing --> Delivered : reach destination
  Delivered --> Processed : service execution
  Processed --> ResponseCreated : create response
  ResponseCreated --> ResponseRouting : send response
  ResponseRouting --> ResponseDelivered : response received
  ResponseDelivered --> [*]
}

state "Overlay States" as Overlay {
  [*] --> Idle
  Idle --> Routing : route message
  Routing --> Idle : delivered
  Idle --> Maintenance : update routing
  Maintenance --> Idle : done
}

Node --> Service : when service available
Service --> Message : process request
Message --> Overlay : use overlay

@enduml